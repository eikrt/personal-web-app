(ns personal-web-app.controllers.routing
  (:require [compojure.core :refer [defroutes context GET POST]]
            [clojure.string :as str]
            [ring.util.response :as ring]
            [personal-web-app.views.display :as view]
            [personal-web-app.models.query :as model]
            [buddy.hashers :as hashers]
            [buddy.auth.accessrules :refer [restrict]]
            [ring.util.response :refer [response redirect]]))
(defn uuid [] (java.util.UUID/randomUUID))
(def userstore (atom {}))
(defn is-authenticated [{user :user :as req}]
  (not (nil? user)))
(defn post-login [{{username "username" password "password"} :form-params
                   session :session :as req}]
  (prn (list :form-params))
  (if-let [user (get-user-by-username-and-password username password)]

    ; If authenticated
    (assoc (ring/redirect "/")
           :session (assoc session :identity (:id user)))
;(ring/redirect "/login")
    ; Otherwise
    (ring/redirect "/login")))

(defn post-logout [{session :session}]
  (assoc (redirect "/")
         :session (dissoc session :identity)))
(defn get-user-by-username-and-password [username password]
  (prn username password)
  (reduce (fn [_ user]
            (if (and (= (:username user) username)
                     (hashers/check password (:password-hash user)))
              (reduced user))) (vals @userstore)))
(defn create-user! [user]
  (let [password (:password user)
        user-id (uuid)]
    (-> user
        (assoc :id user-id :password-hash (hashers/encrypt password))
        (dissoc :password)
        (->> (swap! userstore assoc user-id)))))
(defn index []
  (view/index (model/all)))
(defn login []
  (view/login (model/all)))
(defn post-route []
  (view/post (model/all)))
(defn computer []
  (view/computer [(model/computer)]))
(defn cooking []
  (view/cooking [(model/cooking)]))
(defn other []
  (view/other [(model/other)]))
(defn about []
  (view/about))
(defn create
  [post]
  (when-not (str/blank? (first post))
    (model/create post))
  (ring/redirect "/"))
(defroutes post-routes
  (GET "/" [] (post-route))
  (POST "/" [post] (create post)))
(defroutes routes
  (create-user! {:username "admin" :password "1234"})
  (GET "/" [] (index))
  (GET "/computer" [] (computer))
  (GET "/cooking" [] (cooking))
  (GET "/other" [] (other))
  (GET "/about" [] (about))
  (GET "/login" [] (login))
  (POST "/login" [] post-login );(post-login (str "username=" (first post) "&" "password=" (second post) ) ))
  (POST "/logout"  [] post-logout)
  (context "/post" []
    (restrict post-routes {:handler is-authenticated})))
